# OpenFiscal API

![Node.js](https://img.shields.io/badge/Node.js-20.x_LTS-green)
![Express.js](https://img.shields.io/badge/Express.js-4.x-blue)
![Database](https://img.shields.io/badge/Database-SQLite-orange)
![License](https://img.shields.io/badge/License-ISC-yellow)

API otimizada para consulta de dados fiscais brasileiros (NCM, CEST, IBPT), com baixo uso de mem√≥ria, atualiza√ß√µes autom√°ticas e l√≥gica de busca inteligente.

---

## ‚ö†Ô∏è Aviso Legal e de Responsabilidade

**O objetivo deste reposit√≥rio √© estritamente educacional e colaborativo, visando facilitar o acesso e a consolida√ß√£o de informa√ß√µes fiscais p√∫blicas.**

As informa√ß√µes contidas neste projeto s√£o coletadas de fontes oficiais e p√∫blicas e fontes secundarias como o projeto ACBR, mas s√£o fornecidas "como est√£o", sem garantias de qualquer tipo, expressas ou impl√≠citas, sobre sua precis√£o, completude ou atualidade. A legisla√ß√£o tribut√°ria √© complexa e est√° em constante mudan√ßa.

**A responsabilidade pelo uso das informa√ß√µes obtidas atrav√©s desta API √© inteiramente sua.**

**Observa√ß√£o Importante:** Antes de utilizar os dados desta API em qualquer ambiente de produ√ß√£o ou para fins fiscais oficiais, √© **obrigat√≥rio** que voc√™ consulte seu contador ou um profissional de contabilidade qualificado. Apenas um profissional pode validar e aprovar o uso dessas informa√ß√µes de acordo com as particularidades da sua empresa e a legisla√ß√£o vigente.

---

## üìã Tabela de Conte√∫dos

1.  [Sobre o Projeto](#-sobre-o-projeto)
    * [Principais Funcionalidades](#-principais-funcionalidades)
    * [Tecnologias Utilizadas](#-tecnologias-utilizadas)
2.  [üöÄ Come√ßando](#-come√ßando)
    * [Pr√©-requisitos](#-pr√©-requisitos)
    * [Instala√ß√£o](#-instala√ß√£o)
3.  [‚öôÔ∏è Uso](#Ô∏è-uso)
    * [Scripts Dispon√≠veis](#scripts-dispon√≠veis)
    * [Endpoints da API](#endpoints-da-api)
4.  [üöÄ Implanta√ß√£o com PM2 (Produ√ß√£o)](#-implanta√ß√£o-com-pm2-produ√ß√£o)
    * [Gerenciando a Atualiza√ß√£o Autom√°tica](#gerenciando-a-atualiza√ß√£o-autom√°tica)
5.  [üèóÔ∏è Estrutura do Projeto](#Ô∏è-estrutura-do-projeto)
6.  [üìÑ Licen√ßa](#-licen√ßa)

## üìå Sobre o Projeto

A **OpenFiscal API** √© um servi√ßo de back-end constru√≠do em Node.js que fornece uma interface RESTful para consultar dados fiscais brasileiros de forma r√°pida e eficiente. O sistema foi projetado para resolver a necessidade de acessar informa√ß√µes de **IBPT** (al√≠quotas de impostos) e **CEST** (C√≥digo Especificador da Substitui√ß√£o Tribut√°ria) relacionadas a um **NCM** (Nomenclatura Comum do Mercosul).

O grande diferencial deste projeto √© a sua arquitetura leve e perform√°tica, que utiliza um banco de dados local **SQLite** com um motor de busca de texto completo (FTS5) integrado, garantindo consultas complexas com baixa pegada de mem√≥ria.

### ‚ú® Principais Funcionalidades

* **Consulta Consolidada**: Retorna um objeto de resposta rico com dados do IBPT, totais de tributos calculados e a lista de CESTs correspondentes.
* **Busca Sem√¢ntica por Descri√ß√£o**: Um endpoint poderoso (`/search/:descricao`) que encontra os NCMs mais prov√°veis a partir de uma descri√ß√£o de produto.
* **Busca por CEST**: Um endpoint (`/cest/search/:cest`) para encontrar todos os NCMs associados a um c√≥digo CEST espec√≠fico.
* **Atualiza√ß√£o Autom√°tica**: Um script agendado (`cron`) busca e atualiza **semanalmente** (todo domingo √†s 2h da manh√£) os dados de fontes oficiais.
* **L√≥gica de Busca Inteligente**: A consulta de CEST por NCM encontra sempre a correspond√™ncia mais espec√≠fica (prefixo de NCM mais longo), evitando ambiguidades.
* **Performance Otimizada**: Utiliza consultas preparadas (prepared statements) e √≠ndices otimizados para m√°xima velocidade nas respostas da API.

### üíª Tecnologias Utilizadas

* **Back-end**: Node.js, Express.js
* **Banco de Dados**: SQLite (com a biblioteca `better-sqlite3` e extens√£o FTS5)
* **Coleta de Dados**: Axios (requisi√ß√µes HTTP), Cheerio (web scraping)
* **Processamento de Dados**: csvtojson, json2csv
* **Agendamento de Tarefas**: node-cron

## üöÄ Come√ßando

Siga os passos abaixo para ter uma c√≥pia do projeto rodando localmente.

### ‚úÖ Pr√©-requisitos

* Node.js (vers√£o 20.x LTS ou superior)
* npm (geralmente instalado com o Node.js)

### üì¶ Instala√ß√£o

1.  Clone o reposit√≥rio:
    ```bash
    git clone [https://github.com/facitysistemas/OpenFiscal.git](https://github.com/facitysistemas/OpenFiscal.git)
    ```
2.  Navegue at√© o diret√≥rio do projeto:
    ```bash
    cd OpenFiscal
    ```
3.  Instale as depend√™ncias do NPM:
    ```bash
    npm install
    ```
4.  **Gerar o Banco de Dados (Passo Obrigat√≥rio na Primeira Vez)**:
    Este comando ir√° baixar todos os dados, process√°-los e criar o arquivo de banco de dados `openfiscal.db`. **Este processo pode demorar v√°rios minutos.**
    ```bash
    npm run update-db
    ```
5.  Inicie o servidor da API:
    ```bash
    npm start
    ```
    O servidor estar√° rodando em `http://localhost:7389`.

## ‚öôÔ∏è Uso

### Scripts Dispon√≠veis

* `npm start`: Inicia o servidor da API (`app.js`).
* `npm run update-db`: Executa o script `generateDatabase.js` para criar ou atualizar o banco de dados a partir das fontes oficiais. Use este comando para for√ßar uma atualiza√ß√£o manual.

### Endpoints da API

A URL base da API √© `http://localhost:7389`.

---

#### 1. Endpoints de Busca

* **Busca de NCM por Descri√ß√£o (Sem√¢ntica)**:
    * **Endpoint**: `GET /search/:descricao`
    * **Exemplo**: `GET http://localhost:7389/search/refrigerante`
    * **Resposta**:
        ```json
        [
            {
                "ncm": "22021000",
                "descricao": "√Åguas, incluindo as √°guas minerais e as √°guas gaseificadas, adicionadas de a√ß√∫car..."
            },
            {
                "ncm": "21069010",
                "descricao": "Prepara√ß√µes do tipo utilizado para elabora√ß√£o de bebidas"
            }
        ]
        ```

* **Busca Completa por C√≥digo CEST**:
    * **Endpoint**: `GET /cest/search/:cest`
    * **Exemplo**: `GET http://localhost:7389/cest/search/0100100`
    * **Resposta**:
        ```json
        [
            {
                "cest": "0100100",
                "ncm": "87021000",
                "descricao": "Ve√≠culos autom√≥veis para transporte de 10 pessoas ou mais, incluindo o motorista..."
            }
        ]
        ```

---

#### 2. Consulta Principal e Consolidada

Este √© o endpoint principal. Ele retorna um objeto completo contendo todos os dados fiscais do IBPT, totais de tributos calculados e a lista de CESTs aplic√°veis.

* **Endpoint**: `GET /:uf/:ncm`
* **Exemplo**: `GET http://localhost:7389/sp/39269090`
* **Resposta de Sucesso (200 OK)**:
    ```json
    {
        "Codigo": "39269090",
        "UF": "SP",
        "EX": "001",
        "Descricao": "Outras obras de pl√°sticos",
        "Nacional": 38.41,
        "Estadual": 12.00,
        "Importado": 38.41,
        "Municipal": 0.00,
        "TotalTributosNacionais": 50.41,
        "TotalTributosImportados": 50.41,
        "Tipo": "NBS",
        "VigenciaInicio": "2023-01-01",
        "VigenciaFim": "2023-12-31",
        "Chave": "AAAA-BBBB",
        "Versao": "24.2.A",
        "Fonte": "IBPT",
        "CESTs": [
            {
                "cest": "1400400",
                "ncm": "392690",
                "descricao": "Outras obras de pl√°stico, para transportes"
            }
        ]
    }
    ```

---

#### 3. Endpoints de Consulta Direta (Dados Brutos)

* **Consulta de IBPT**:
    * **Endpoint**: `GET /ibpt/:uf/:ncm`
    * **Exemplo**: `GET http://localhost:7389/ibpt/sp/39269090`

* **Consulta de CEST por NCM**:
    * **Endpoint**: `GET /cest/:ncm`
    * **Exemplo**: `GET http://localhost:7389/cest/39269090`

---

## üöÄ Implanta√ß√£o com PM2 (Produ√ß√£o)

Para rodar esta API em um ambiente de produ√ß√£o, √© altamente recomendado usar um gerenciador de processos como o **PM2**. Ele manter√° a API online 24/7, reiniciando-a automaticamente em caso de falhas e facilitando o gerenciamento de logs.

1.  **Instale o PM2 globalmente**:
    ```bash
    npm install pm2 -g
    ```
2.  **Inicie a API com o PM2**:
    Navegue at√© a pasta do projeto e execute:
    ```bash
    pm2 start app.js --name "openfiscal-api"
    ```
    * `--name "openfiscal-api"`: Define um nome f√°cil de gerenciar para o processo.

3.  **Monitore a API**:
    Para ver o status de todos os processos gerenciados pelo PM2:
    ```bash
    pm2 list
    ```
    Para um monitoramento em tempo real no terminal:
    ```bash
    pm2 monit
    ```
4.  **Gerencie os Logs**:
    Para visualizar os logs da API em tempo real:
    ```bash
    pm2 logs openfiscal-api
    ```

5.  **Comandos √öteis de Gerenciamento**:
    ```bash
    pm2 stop openfiscal-api      # Parar a API
    pm2 restart openfiscal-api   # Reiniciar a API
    pm2 delete openfiscal-api    # Remover a API da lista do PM2
    ```
6.  **Salvar a lista de processos**:
    Para garantir que o PM2 reinicie suas aplica√ß√µes ap√≥s uma reinicializa√ß√£o do servidor, execute os seguintes comandos:
    ```bash
    pm2 save          # Salva a lista de processos atual
    pm2 startup       # Gera um script de inicializa√ß√£o para o seu sistema operacional
    ```
    O comando `pm2 startup` ir√° gerar e exibir um comando que voc√™ deve copiar e colar no seu terminal para finalizar a configura√ß√£o.

### Gerenciando a Atualiza√ß√£o Autom√°tica

O script `generateDatabase.js` cont√©m uma tarefa agendada que precisa estar sempre em execu√ß√£o para manter o banco de dados atualizado. √â uma boa pr√°tica gerenci√°-lo com o PM2 tamb√©m.

1.  **Inicie o script de atualiza√ß√£o com o PM2**:
    ```bash
    pm2 start generateDatabase.js --name "openfiscal-updater"
    ```
2.  **Verifique o status de ambos os processos**:
    Ap√≥s iniciar os dois servi√ßos, o comando `pm2 list` dever√° mostrar algo assim:
    ```
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ id ‚îÇ name                 ‚îÇ mode     ‚îÇ ‚Ü∫    ‚îÇ status    ‚îÇ cpu      ‚îÇ memory   ‚îÇ
    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
    ‚îÇ 0  ‚îÇ openfiscal-api       ‚îÇ fork     ‚îÇ 0    ‚îÇ online    ‚îÇ 0%       ‚îÇ 50mb     ‚îÇ
    ‚îÇ 1  ‚îÇ openfiscal-updater   ‚îÇ fork     ‚îÇ 0    ‚îÇ online    ‚îÇ 0%       ‚îÇ 35mb     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ```
3.  **Gerenciamento**:
    Todos os comandos do PM2 (`logs`, `stop`, `restart`) tamb√©m funcionam para o processo `openfiscal-updater`. Para salvar ambos os processos para reinicializa√ß√£o do servidor, basta executar `pm2 save` ap√≥s ter iniciado os dois.

## üèóÔ∏è Estrutura do Projeto
* `/`
    * `node_modules/`: Depend√™ncias do projeto
    * `.gitignore`: Arquivos ignorados pelo Git
    * `app.js`: O servidor da API (Express.js)
    * `generateDatabase.js`: Script para criar e atualizar o banco de dados
    * `package.json`: Manifesto do projeto e depend√™ncias
    * `package-lock.json`: Lock das vers√µes das depend√™ncias
    * `README.md`: Este arquivo

**Arquivos Gerados (ap√≥s `npm run update-db`):**

* `openfiscal.db`: Arquivo do banco de dados SQLite.
* `cest_metadata.json`: Arquivo de controle para a atualiza√ß√£o do CEST.
* `openfiscal_completo.json`: Exporta√ß√£o completa dos dados em formato JSON.
* `openfiscal_completo.csv`: Exporta√ß√£o completa dos dados em formato CSV.

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa ISC. Veja o arquivo `package.json` para mais detalhes.
